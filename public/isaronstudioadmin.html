<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yalorde Admin | Panel de Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/toast.css"> <!-- Toast Styles -->
    <script src="/js/toast.js"></script> <!-- Toast Logic -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Client-side auth check removed (cookie is httpOnly) -->
    <style>
        :root {
            --primary: #e84393;
            --dark: #2d3436;
            --light: #f5f6fa;
            --gray: #dfe6e9;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            background: #f1f2f6;
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ddd;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item {
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            color: #666;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #fff0f6;
            color: var(--primary);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        .logout-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            color: #666;
        }

        /* Forms & Cards */
        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            box-sizing: border-box;
        }

        .submit-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }

        /* Inventory List */
        .inv-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: white;
        }

        .inv-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .inv-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
        }

        .btn-action {
            width: 35px;
            height: 35px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            margin-left: 5px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        .btn-edit {
            background: #fff3cd;
            color: #856404;
        }

        .btn-delete {
            background: #f8d7da;
            color: #721c24;
        }

        /* Upload Button */
        .upload-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .upload-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }

        .upload-btn {
            border: 2px dashed #ddd;
            color: #666;
            background: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            display: block;
        }

        .upload-btn.drag-active {
            border-color: var(--primary);
            background: #fff0f6;
        }

        /* Views Visibility */
        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        /* Order Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        th {
            color: #888;
            font-weight: 500;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        /* Color Picker overrides */
        input[type="color"] {
            height: 50px;
            padding: 5px;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="brand">
            <img src="/assets/logo.png" alt="Yalorde" style="height: 60px; width: auto;">
        </div>
        <div class="nav-item active" onclick="switchTab('dashboard')">
            <i class="fa-solid fa-chart-line"></i> Estad√≠sticas
        </div>
        <div class="nav-item" onclick="switchTab('orders')">
            <i class="fa-solid fa-cart-shopping"></i> Gesti√≥n de Pedidos
        </div>
        <div class="nav-item" onclick="switchTab('inventory')">
            <i class="fa-solid fa-boxes-stacked"></i> Inventario / Stock
        </div>
        <div class="nav-item" onclick="switchTab('cms')">
            <i class="fa-solid fa-pen-to-square"></i> Editar P√°gina Web
        </div>
        <div class="nav-item" style="margin-top:auto; background:rgba(255,255,255,0.1);"
            onclick="window.location.href='/'">
            <i class="fa-solid fa-arrow-left"></i> Volver a la Tienda
        </div>
        <div style="flex:1"></div>
        <button class="logout-btn" onclick="document.cookie='admin_auth=; Max-Age=0'; location.reload()">
            <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesi√≥n
        </button>
    </div>

    <div class="main-content">
        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="view-section active">
            <div class="header">
                <div class="page-title">Resumen Estrat√©gico</div>
            </div>

            <!-- KPI Cards -->
            <div
                style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:30px;">
                <div class="card" style="text-align:center;">
                    <div style="font-size:0.9rem; color:#666; margin-bottom:10px;">Ventas Totales</div>
                    <div id="stat-revenue" style="font-size:1.8rem; font-weight:700; color:var(--primary);">$0.00</div>
                </div>
                <div class="card" style="text-align:center;">
                    <div style="font-size:0.9rem; color:#666; margin-bottom:10px;">Pedidos Pendientes</div>
                    <div id="stat-pending" style="font-size:1.8rem; font-weight:700; color:orange;">0</div>
                </div>
                <div class="card" style="text-align:center;">
                    <div style="font-size:0.9rem; color:#666; margin-bottom:10px;">Stock Bajo (< 5)</div>
                            <div id="stat-low-stock" style="font-size:1.8rem; font-weight:700; color:red;">0</div>
                    </div>
                </div>

                <div class="card">
                    <h3>Tendencia de Ventas (7 D√≠as)</h3>
                    <canvas id="salesChart" height="100"></canvas>
                </div>

                <div class="card" id="dashboard-low-stock-card" style="display:none; margin-top:20px;">
                    <h3 style="color:#ff4757;"><i class="fa-solid fa-triangle-exclamation"></i> Stock Bajo Requerido
                    </h3>
                    <div id="dashboard-low-stock-list"></div>
                </div>
            </div>

            <!-- INVENTORY VIEW -->
            <div id="view-inventory" class="view-section">
                <div class="header">
                    <div class="page-title">Inventario de Productos</div>
                </div>

                <div class="card">
                    <h3 style="margin-top:0; margin-bottom:20px;" id="form-header-title">Agregar Nuevo Producto</h3>
                    <form id="product-form">
                        <input type="hidden" id="edit-id" value="">

                        <div class="form-grid">
                            <input type="text" name="title" id="inp-title" placeholder="Nombre del Producto" required>
                            <select name="category" id="inp-category" required>
                                <option value="" disabled selected>Categor√≠a</option>
                                <option value="vestidos">Vestidos</option>
                                <option value="tops">Blusas & Tops</option>
                                <option value="bottoms">Pantalones</option>
                                <option value="calzado">Calzado</option>
                            </select>
                        </div>

                        <div class="form-grid">
                            <input type="number" name="price" id="inp-price" placeholder="Precio ($)" step="0.01"
                                required>
                            <input type="text" id="inp-desc" name="description" placeholder="Descripci√≥n Breve"
                                required>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="font-size:0.9rem; color:#666; display:block; margin-bottom:10px;">Stock por
                                Talla</label>
                            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                                <input type="number" id="qty-s" placeholder="S" min="0">
                                <input type="number" id="qty-m" placeholder="M" min="0">
                                <input type="number" id="qty-l" placeholder="L" min="0">
                            </div>
                        </div>

                        <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 20px;">
                            <div style="display:flex; align-items:center; gap:5px;">
                                <input type="checkbox" name="isTrending" id="inp-trending" style="width: auto;">
                                <label for="inp-trending">üî• Tendencia</label>
                            </div>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <input type="checkbox" name="isOffer" id="inp-offer" style="width: auto;">
                                <label for="inp-offer">üè∑Ô∏è En Oferta</label>
                            </div>
                        </div>

                        <div class="upload-wrapper" id="drop-zone">
                            <button type="button" class="upload-btn btn-file">üì∏ Subir Imagen del Producto</button>
                            <input type="file" name="image" id="file-input" accept="image/*">
                        </div>
                        <small id="current-img-msg"
                            style="display:none; color:#666; margin-bottom:15px; display:block;">(Deja vac√≠o para
                            mantener
                            la imagen actual)</small>

                        <div style="display:flex; gap:10px; margin-top:20px;">
                            <button type="submit" class="submit-btn" id="save-btn">Guardar Producto</button>
                            <button type="button" class="submit-btn" id="cancel-btn"
                                style="background:#ccc; display:none;" onclick="resetForm()">Cancelar</button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h3 id="inv-list-title">Lista de Productos</h3>
                    <div id="inv-list">
                        <!-- Products here -->
                        <p style="text-align:center; color:#999;">Cargando inventario...</p>
                    </div>
                </div>
            </div>

            <!-- ORDERS VIEW -->
            <div id="view-orders" class="view-section">
                <div class="header" style="flex-wrap: wrap; gap: 10px;">
                    <div class="page-title">Gesti√≥n de Pedidos</div>
                    <div style="display:flex; gap:10px; flex-grow: 1; justify-content: flex-end;">
                        <input type="text" id="order-search" placeholder="üîç Buscar nombre, ref..."
                            onkeyup="filterOrders()"
                            style="padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 200px;">
                        <select id="order-filter-status" onchange="filterOrders()"
                            style="padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                            <option value="all">Todos los Estados</option>
                            <option value="pending">üü° Pendientes</option>
                            <option value="approved">üü¢ Aprobados</option>
                            <option value="shipped">üöö Enviados</option>
                            <option value="delivered">‚úÖ Entregados</option>
                            <option value="cancelled">‚ùå Cancelados</option>
                        </select>
                        <button class="logout-btn" onclick="fetchOrders()"><i class="fa-solid fa-rotate"></i></button>
                    </div>
                </div>

                <div class="card" style="overflow-x:auto;">
                    <table id="orders-table">
                        <thead>
                            <tr>
                                <th onclick="sortOrders('date')" style="cursor:pointer">Fecha ‚Üï</th>
                                <th onclick="sortOrders('customer')" style="cursor:pointer">Cliente ‚Üï</th>
                                <th>Estado</th>
                                <th>Total</th>
                                <th>Pago</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="orders-list">
                            <!-- Orders injected here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ORDER EDIT MODAL -->
            <div id="order-modal" class="modal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
                <div class="card" style="width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
                    <h3 style="margin-top:0;">Detalle de Pedido</h3>
                    <div id="order-modal-content"></div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button type="button" class="btn-cancel"
                            onclick="document.getElementById('order-modal').style.display='none'">Cerrar</button>
                        <button type="button" class="submit-btn" id="save-order-btn">Guardar Cambios</button>
                    </div>
                </div>
            </div>

            <!-- CMS VIEW (Personalizar) -->
            <div id="view-cms" class="view-section">
                <div class="header">
                    <div class="page-title">Personalizar Tienda</div>
                </div>

                <div class="card">
                    <h3>üé® Apariencia</h3>
                    <form id="cms-form">
                        <div class="form-grid">
                            <div>
                                <label>Color Principal (Botones, Iconos)</label>
                                <input type="color" name="themeColor" id="cms-color" value="#e84393">
                            </div>
                            <div>
                                <label>Mensaje Barra Superior</label>
                                <input type="text" name="infoBar" id="cms-infobar"
                                    placeholder="Ej: Env√≠o Gratis a toda Venezuela üáªüá™">
                            </div>
                        </div>

                        <div class="form-grid">
                            <div>
                                <label>T√≠tulo Principal</label>
                                <input type="text" name="heroTitle" id="cms-hero-title"
                                    placeholder="Ej: Nueva Colecci√≥n 2024">
                            </div>
                            <div>
                                <label>Subt√≠tulo</label>
                                <input type="text" name="heroSubtitle" id="cms-hero-sub"
                                    placeholder="Ej: Brilla con luz propia">
                            </div>
                        </div>

                        <h3>üñºÔ∏è Im√°genes de Fondo</h3>
                        <div class="form-grid">
                            <div>
                                <label>Fondo de Pantalla (se difuminar√° autom√°ticamente)</label>
                                <input type="file" id="cms-bg-upload" accept="image/*"
                                    style="padding:10px; border:1px solid #ddd; border-radius:8px;">
                                <small style="display:block; color:#666; margin-top:5px;">La imagen se aplicar√° con
                                    efecto blur autom√°tico</small>
                            </div>
                            <div>
                                <label>Imagen Hero Banner (imagen grande superior)</label>
                                <input type="file" id="cms-hero-upload" accept="image/*"
                                    style="padding:10px; border:1px solid #ddd; border-radius:8px;">
                                <small style="display:block; color:#666; margin-top:5px;">Imagen principal del banner de
                                    inicio</small>
                            </div>
                        </div>

                        <h3>üì± Redes Sociales & Contacto</h3>
                        <div class="form-grid">
                            <input type="text" name="whatsapp" id="cms-wa"
                                placeholder="Link WhatsApp (https://wa.me/...)">
                            <input type="text" name="instagram" id="cms-ig" placeholder="Link Instagram">
                            <input type="text" name="tiktok" id="cms-tt" placeholder="Link TikTok">
                        </div>

                        <button type="submit" class="submit-btn" style="margin-top: 20px;">Guardar Cambios</button>
                    </form>
                </div>
            </div>

        </div>

        <!-- MAIN SCRIPT -->
        <script>
            let adminRole = sessionStorage.getItem('admin_role') || 'owner';
            let allProducts = [];
            let allOrders = [];

            function checkRoleAccess() {
                if (adminRole === 'owner') {
                    // Hide Add Product Form Card
                    const productFormCard = document.querySelector('#view-inventory .card:first-of-type');
                    if (productFormCard) productFormCard.style.display = 'none';

                    // Change Inventory Page Title to something more passive
                    const invTitle = document.querySelector('#view-inventory .page-title');
                    if (invTitle) invTitle.textContent = "Consulta de Stock";
                }
            }

            async function fetchStats() {
                try {
                    const res = await fetch('/api/admin/stats');
                    const data = await res.json();

                    if (document.getElementById('stat-revenue')) document.getElementById('stat-revenue').textContent = `$${(data.totalRevenue || 0).toFixed(2)}`;

                    const pending = (data.statusDistribution || []).find(s => s._id === 'pending')?.count || 0;
                    if (document.getElementById('stat-pending')) document.getElementById('stat-pending').textContent = pending;

                    if (document.getElementById('stat-low-stock')) document.getElementById('stat-low-stock').textContent = data.lowStockCount || 0;

                    if (data.weeklySales) renderChart(data.weeklySales);
                } catch (err) {
                    console.error("Error fetching stats:", err);
                }
            }

            let salesChart = null;
            function renderChart(weeklyData) {
                const ctx = document.getElementById('salesChart').getContext('2d');

                const labels = weeklyData.map(d => d._id);
                const totals = weeklyData.map(d => d.total);

                if (salesChart) salesChart.destroy();

                salesChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Ventas Daily ($)',
                            data: totals,
                            borderColor: '#e84393',
                            backgroundColor: 'rgba(232, 67, 147, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // --- NAVIGATION ---
            function switchTab(tabId) {
                // Update Navigation UI
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.onclick.toString().includes(tabId)) {
                        item.classList.add('active');
                    }
                });

                // Update Section Visibility
                document.querySelectorAll('.view-section').forEach(view => {
                    view.classList.remove('active');
                });
                document.getElementById('view-' + tabId).classList.add('active');

                // Specialized Actions
                if (tabId === 'inventory') fetchProducts();
                if (tabId === 'orders') fetchOrders();
                if (tabId === 'cms') fetchCMS(); // Assuming 'cms' is the correct tabId for fetchCMS
                if (tabId === 'dashboard') fetchStats();
            }

            // --- INVENTORY LOGIC ---
            async function fetchProducts() {
                try {
                    const res = await fetch('/api/products');
                    allProducts = await res.json();
                    renderInventory(allProducts);
                } catch (e) { console.error(e); Toast.error('Error cargando productos'); }
            }

            function renderInventory(products) {
                const list = document.getElementById('inv-list');
                if (!products || !Array.isArray(products)) {
                    list.innerHTML = '<p style="text-align:center; color:red;">Error al procesar productos.</p>';
                    return;
                }
                if (products.length === 0) {
                    list.innerHTML = '<p style="text-align:center; color:#999;">No hay productos registrados.</p>';
                    return;
                }

                const sorted = [...products].sort((a, b) => a.isTrending ? -1 : 1); // Trending first

                list.innerHTML = sorted.map(p => {
                    const sizes = p.sizes || {};
                    const totalStock = Object.values(sizes).reduce((acc, val) => acc + (val.stock || 0), 0);
                    const isLowStock = totalStock <= 5;

                    return `
                    <div class="inv-item" style="${isLowStock ? 'border-left: 4px solid #ff4757; background: #fffafb;' : ''}">
                        <div class="inv-info">
                            <img src="${p.img || 'https://via.placeholder.com/50'}" class="inv-img">
                            <div>
                                <div style="font-weight:600;">
                                    ${p.title} 
                                    ${p.isTrending ? 'üî•' : ''}
                                    ${p.isOffer ? '<span style="font-size:0.8em; background:#ffeaa7; padding:2px 5px; border-radius:4px;">üè∑Ô∏è</span>' : ''}
                                </div>
                                <div style="font-size:0.8rem; color:#888;">
                                    $${(p.price || 0).toFixed(2)} | 
                                    <span style="${isLowStock ? 'color:#ff4757; font-weight:bold;' : ''}">Stock: ${totalStock}</span>
                                    ${isLowStock ? '<span style="background:#ff4757; color:white; padding:2px 6px; border-radius:4px; font-size:0.65rem; margin-left:5px;">BAJO STOCK</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <div style="${adminRole === 'owner' ? 'display:none;' : ''}">
                            <button class="btn-action btn-edit" onclick="editProduct('${p.id}')"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn-action btn-delete" onclick="deleteProduct('${p.id}')"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
                }).join('');
            }

            // Edit Product (Populate Form)
            function editProduct(id) {
                const p = allProducts.find(prod => String(prod.id) === String(id));
                if (!p) return;

                document.getElementById('edit-id').value = p.id;
                document.getElementById('inp-title').value = p.title;
                document.getElementById('inp-category').value = p.category;
                document.getElementById('inp-price').value = p.price;
                document.getElementById('inp-desc').value = p.description;
                document.getElementById('inp-trending').checked = !!p.isTrending;
                document.getElementById('inp-offer').checked = !!p.isOffer;

                document.getElementById('qty-s').value = p.sizes.S ? p.sizes.S.stock : 0;
                document.getElementById('qty-m').value = p.sizes.M ? p.sizes.M.stock : 0;
                document.getElementById('qty-l').value = p.sizes.L ? p.sizes.L.stock : 0;

                // UI Changes
                document.getElementById('form-header-title').textContent = "Editar Producto";
                document.getElementById('save-btn').textContent = "Actualizar";
                document.getElementById('cancel-btn').style.display = 'block';
                document.getElementById('current-img-msg').style.display = 'block';

                document.querySelector('.main-content').scrollTop = 0;
            }

            function resetForm() {
                document.getElementById('product-form').reset();
                document.getElementById('edit-id').value = "";
                document.getElementById('form-header-title').textContent = "Agregar Nuevo Producto";
                document.getElementById('save-btn').textContent = "Guardar Producto";
                document.getElementById('cancel-btn').style.display = 'none';
                document.getElementById('current-img-msg').style.display = 'none';
            }

            // Submit Product
            document.getElementById('product-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('save-btn');
                btn.textContent = "Guardando...";
                btn.disabled = true;

                const formData = new FormData(e.target);
                const sizes = {
                    "S": { stock: parseInt(document.getElementById('qty-s').value) || 0 },
                    "M": { stock: parseInt(document.getElementById('qty-m').value) || 0 },
                    "L": { stock: parseInt(document.getElementById('qty-l').value) || 0 }
                };
                formData.append('sizes', JSON.stringify(sizes));
                formData.append('isTrending', document.getElementById('inp-trending').checked);
                formData.append('isOffer', document.getElementById('inp-offer').checked);
                const editId = document.getElementById('edit-id').value;

                try {
                    const url = editId ? `/api/products/${editId}` : '/api/products';
                    const method = editId ? 'PUT' : 'POST';

                    const res = await fetch(url, { method, body: formData });
                    if (res.ok) {
                        Toast.success("Producto guardado exitosamente");
                        resetForm();
                        fetchProducts();
                    } else {
                        Toast.error("Error al guardar");
                    }
                } catch (err) { Toast.error("Error de conexi√≥n"); }
                finally { btn.textContent = editId ? "Actualizar" : "Guardar Producto"; btn.disabled = false; }
            });

            async function deleteProduct(id) {
                if (!confirm("¬øEST√ÅS SEGURO? Se borrar√° para siempre.")) return;
                try {
                    const res = await fetch(`/api/products/${id}`, { method: 'DELETE' });
                    if (res.ok) { Toast.success("Producto eliminado"); fetchProducts(); }
                    else Toast.error("Error al eliminar");
                } catch (e) { Toast.error("Error de conexi√≥n"); }
            }

            // --- ORDERS LOGIC 2.0 ---
            let lastOrderCount = 0; // Track order count for notifications
            let isFirstLoad = true; // Don't notify on first load

            async function fetchOrders() {
                try {
                    const res = await fetch('/api/orders');
                    allOrders = await res.json();

                    // Check for new orders
                    if (!isFirstLoad && allOrders.length > lastOrderCount) {
                        playNotificationSound();
                        Toast.success(`üîî ¬°Nuevo pedido recibido! Total: ${allOrders.length}`);
                    }

                    lastOrderCount = allOrders.length;
                    isFirstLoad = false;

                    renderOrders(allOrders);
                } catch (e) { Toast.error("Error cargando pedidos"); }
            }

            // Play notification sound
            function playNotificationSound() {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Beautiful bell-like sound
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }

            // Auto-refresh orders every 30 seconds
            setInterval(() => {
                const currentView = document.querySelector('.view-section.active');
                if (currentView && currentView.id === 'view-orders') {
                    fetchOrders();
                }
            }, 5000); // 5 seconds

            function renderOrders(orders) {
                const tbody = document.getElementById('orders-list');
                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No hay pedidos encontrados.</td></tr>';
                    return;
                }

                const statusColors = {
                    'pending': '#f1c40f', 'approved': '#2ecc71', 'shipped': '#3498db',
                    'delivered': '#9b59b6', 'cancelled': '#e74c3c'
                };
                const statusLabels = {
                    'pending': 'Pendiente', 'approved': 'Aprobado', 'shipped': 'Enviado',
                    'delivered': 'Entregado', 'cancelled': 'Cancelado'
                };

                const payStatusColors = { 'pending': '#fff3cd', 'verified': '#d4edda', 'rejected': '#f8d7da' };
                const payStatusLabels = { 'pending': 'üü° Pendiente', 'verified': 'üü¢ Verificado', 'rejected': 'üî¥ Rechazado' };

                tbody.innerHTML = orders.map(o => {
                    const custName = typeof o.customer === 'object' ? o.customer.name : o.customer;
                    const trackingDisplay = o.trackingCode ? `<span style="color:var(--primary); font-weight:800;">#${o.trackingCode}</span>` : `<small>#${o._id.slice(-6).toUpperCase()}</small>`;

                    return `
                <tr>
                    <td>
                        ${trackingDisplay}<br>
                        <small style="color:#666">${new Date(o.date).toLocaleDateString()}</small>
                    </td>
                    <td>
                        <strong>${custName}</strong><br>
                        <small style="color:#666">${o.paymentRef}</small>
                    </td>
                    <td><span style="background:${statusColors[o.status] || '#ccc'}; color:white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">
                        ${statusLabels[o.status] || o.status}
                    </span></td>
                    <td style="font-weight:bold;">$${o.total.toFixed(2)}</td>
                    <td>
                        <div style="font-weight:600; font-size:0.9em;">${o.paymentMethod.toUpperCase()}</div>
                        <span style="font-size:0.75em; padding:2px 6px; border-radius:4px; background:${payStatusColors[o.paymentStatus] || '#eee'}; display:inline-block; margin-top:2px;">
                            ${payStatusLabels[o.paymentStatus] || o.paymentStatus}
                        </span>
                        ${o.paymentProofUrl ? `<i class="fa-solid fa-image" style="color:var(--primary); margin-left:5px; cursor:pointer;" onclick="window.open('${o.paymentProofUrl}')" title="Ver Comprobante"></i>` : ''}
                    </td>
                    <td>
                        <button class="btn-action btn-edit" onclick='openOrderModal("${o._id}")'><i class="fa-solid fa-eye"></i></button>
                        <button class="btn-action btn-delete" onclick="deleteOrder('${o._id}')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `}).join('');
            }

            function filterOrders() {
                const term = document.getElementById('order-search').value.toLowerCase();
                const status = document.getElementById('order-filter-status').value;

                const filtered = allOrders.filter(o => {
                    const custName = typeof o.customer === 'object' ? o.customer.name : o.customer;
                    const matchesTerm = custName.toLowerCase().includes(term) ||
                        o.paymentRef.toLowerCase().includes(term) ||
                        o._id.toLowerCase().includes(term);
                    const matchesStatus = status === 'all' || o.status === status;
                    return matchesTerm && matchesStatus;
                });
                renderOrders(filtered);
            }

            let sortDesc = true;
            function sortOrders(field) {
                sortDesc = !sortDesc;
                allOrders.sort((a, b) => {
                    let valA = field === 'customer' ? (typeof a.customer === 'object' ? a.customer.name : a.customer) : a[field];
                    let valB = field === 'customer' ? (typeof b.customer === 'object' ? b.customer.name : b.customer) : b[field];

                    if (valA < valB) return sortDesc ? 1 : -1;
                    if (valA > valB) return sortDesc ? -1 : 1;
                    return 0;
                });
                renderOrders(allOrders);
            }

            function openOrderModal(id) {
                const order = allOrders.find(o => o._id === id);
                if (!order) return;

                const cust = typeof order.customer === 'object' ? order.customer : { name: order.customer };

                const html = `
                <div style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:15px; text-align:center;">
                    <span style="font-size:0.8rem; color:#666;">TRACKING ID</span><br>
                    <span style="font-size:1.5rem; font-weight:800; color:var(--primary); letter-spacing:2px;">${order.trackingCode || '‚Äî'}</span>
                    ${!order.trackingCode ? `<br><small style="color:#999; font-size:0.7rem;">(Pedido antiguo: #${order._id.slice(-6).toUpperCase()})</small>` : ''}
                </div>

                <div class="form-grid">
                    <div>
                        <label>Estado del Pedido</label>
                        <select id="edit-order-status" style="width:100%; padding:8px;">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pendiente</option>
                            <option value="approved" ${order.status === 'approved' ? 'selected' : ''}>Aprobado (Pago Verificado)</option>
                            <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Enviado</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Entregado</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelado</option>
                        </select>
                    </div>
                    <div>
                        <label>Estado de Pago</label>
                        <select id="edit-payment-status" style="width:100%; padding:8px;">
                            <option value="pending" ${order.paymentStatus === 'pending' ? 'selected' : ''}>üü° Pendiente</option>
                            <option value="verified" ${order.paymentStatus === 'verified' ? 'selected' : ''}>üü¢ Verificado</option>
                            <option value="rejected" ${order.paymentStatus === 'rejected' ? 'selected' : ''}>üî¥ Rechazado</option>
                        </select>
                    </div>
                </div>

                <div class="form-grid">
                    <div>
                        <label>Tracking / Gu√≠a</label>
                        <input type="text" id="edit-order-tracking" value="${order.trackingCode || ''}" placeholder="N√∫mero de gu√≠a...">
                    </div>
                </div>

                ${order.paymentProofUrl ? `
                <h4>üñºÔ∏è Comprobante de Pago</h4>
                <div style="text-align:center; background:#eee; padding:10px; border-radius:8px; margin-bottom:15px;">
                    <img src="${order.paymentProofUrl}" style="max-width:100%; max-height:300px; border-radius:5px; cursor:pointer;" onclick="window.open(this.src)">
                    <p style="font-size:0.8rem; color:#666; margin-top:5px;">Haz clic en la imagen para verla en tama√±o completo</p>
                </div>
                ` : ''}

                <h4>üì¶ Items</h4>
                <ul style="list-style:none; padding:0; background:#f9f9f9; padding:10px; border-radius:8px;">
                    ${order.items.map(i => `
                        <li style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:5px 0;">
                            <span>${i.qty}x ${i.title} (${i.size})</span>
                            <span>$${(i.price * i.qty).toFixed(2)}</span>
                        </li>
                    `).join('')}
                    <li style="display:flex; justify-content:space-between; font-weight:bold; margin-top:5px;">
                        <span>TOTAL</span>
                        <span>$${order.total.toFixed(2)}</span>
                    </li>
                </ul>

                <h4>üë§ Datos del Cliente</h4>
                <p><strong>Nombre:</strong> ${cust.name}</p>
                <p><strong>C√©dula:</strong> ${cust.docId || '-'}</p>
                <p><strong>Tel√©fono:</strong> ${cust.phone || '-'}</p>
                <p><strong>Email:</strong> ${cust.email || '-'}</p>
                <div style="background:#fff3cd; padding:10px; border-radius:5px; margin-top:5px;">
                    <strong>üìç Direcci√≥n:</strong><br>
                    ${cust.address || '-'}
                </div>

                <div style="margin-top:20px;">
                    <label>üí¨ Mensaje para el Cliente</label>
                    <small style="display:block; color:#666; margin-bottom:5px;">Este mensaje se mostrar√° al cliente cuando rastree su pedido. √ösalo para explicar demoras, cancelaciones o dar actualizaciones.</small>
                    <textarea id="edit-order-notes" rows="3" style="width:100%;" placeholder="Ej: Tu pedido ser√° enviado ma√±ana por MRW. Llegar√° en 2-3 d√≠as h√°biles.">${order.notes || ''}</textarea>
                </div>
            `;

                document.getElementById('order-modal-content').innerHTML = html;
                document.getElementById('order-modal').style.display = 'flex';

                document.getElementById('save-order-btn').onclick = () => updateOrder(id);
            }

            async function updateOrder(id) {
                const status = document.getElementById('edit-order-status').value;
                const paymentStatus = document.getElementById('edit-payment-status').value;
                const tracking = document.getElementById('edit-order-tracking').value;
                const notes = document.getElementById('edit-order-notes').value;

                try {
                    const res = await fetch(`/api/orders/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status, paymentStatus, trackingCode: tracking, notes })
                    });

                    if (res.ok) {
                        Toast.success("Pedido actualizado");
                        document.getElementById('order-modal').style.display = 'none';
                        fetchOrders();
                    } else {
                        Toast.error("Error al actualizar");
                    }
                } catch (e) { Toast.error("Error de conexi√≥n"); }
            }

            async function deleteOrder(id) {
                if (!confirm("¬øEST√ÅS SEGURO? Esta acci√≥n no se puede deshacer.")) return;
                try {
                    const res = await fetch(`/api/orders/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        Toast.success("Pedido eliminado permanentemente");
                        fetchOrders();
                    } else Toast.error("Error al eliminar");
                } catch (e) { Toast.error("Error de conexi√≥n"); }
            }

            // --- CMS LOGIC ---
            async function fetchCMS() {
                try {
                    const res = await fetch('/api/content');
                    const content = await res.json();

                    if (content.themeColor) document.getElementById('cms-color').value = content.themeColor;
                    if (content.infoBar) document.getElementById('cms-infobar').value = content.infoBar;
                    if (content.heroTitle) document.getElementById('cms-hero-title').value = content.heroTitle;
                    if (content.heroSubtitle) document.getElementById('cms-hero-sub').value = content.heroSubtitle;
                    if (content.whatsapp) document.getElementById('cms-wa').value = content.whatsapp;
                    if (content.instagram) document.getElementById('cms-ig').value = content.instagram;
                    if (content.tiktok) document.getElementById('cms-tt').value = content.tiktok;
                } catch (e) { console.error(e); }
            }

            document.getElementById('cms-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);

                // Helper to convert file to Base64
                const toBase64 = file => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });

                try {
                    // Handle Background Image Upload
                    const bgFile = document.getElementById('cms-bg-upload').files[0];
                    if (bgFile) {
                        data.backgroundImage = await toBase64(bgFile);
                    }

                    // Handle Hero Image Upload
                    const heroFile = document.getElementById('cms-hero-upload').files[0];
                    if (heroFile) {
                        data.heroImg = await toBase64(heroFile);
                    }

                    Toast.info("Guardando configuraci√≥n...");

                    const res = await fetch('/api/content', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (res.ok) Toast.success("¬°Tienda actualizada! Recarga para ver cambios.");
                    else Toast.error("Error guardando cambios");
                } catch (e) {
                    console.error(e);
                    Toast.error("Error al procesar im√°genes o conexi√≥n");
                }
            });

            // --- UPLOAD DRAG & DROP ---
            const dropZone = document.getElementById('drop-zone');
            const fileInp = document.getElementById('file-input');
            const btnFile = document.querySelector('.btn-file');

            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.querySelector('.upload-btn').classList.add('drag-active'); });
                dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.querySelector('.upload-btn').classList.remove('drag-active'); });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.querySelector('.upload-btn').classList.remove('drag-active');
                    if (e.dataTransfer.files.length) {
                        fileInp.files = e.dataTransfer.files;
                        btnFile.textContent = "‚úÖ " + fileInp.files[0].name;
                    }
                });
                fileInp.addEventListener('change', () => {
                    if (fileInp.files.length) btnFile.textContent = "‚úÖ " + fileInp.files[0].name;
                });
            }

            // Initialize Admin Panel
            window.addEventListener('load', () => {
                console.log("Admin Panel Init as:", adminRole);
                checkRoleAccess();
                fetchStats();
                fetchProducts();
                fetchOrders();
                fetchCMS();
            });

        </script>
</body>

</html>