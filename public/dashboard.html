<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yalorde Admin | Panel de Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        if (!sessionStorage.getItem('admin_logged_in')) {
            window.location.href = '/login';
        }
    </script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background: #f4f6f8;
            margin: 0;
            padding: 20px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn-delete {
            background: #ffcccc;
            color: #d9534f;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .btn-delete:hover {
            background: #d9534f;
            color: white;
        }

        .admin-header h2 {
            margin: 0;
            color: #333;
        }

        .back-link {
            text-decoration: none;
            color: #666;
            font-size: 0.9rem;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .stat-num {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
            display: block;
            margin-top: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Add Product Form */
        .add-product-form {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        .form-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #444;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        @media (min-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
        }

        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
            transition: all 0.3s;
        }

        .upload-btn-wrapper.drag-active .btn-file {
            background-color: #e9f5ff;
            border-color: #007bff;
            color: #007bff;
        }

        .btn-file {
            border: 2px dashed #ddd;
            color: #888;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            text-align: center;
        }

        .upload-btn-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }

        .submit-btn {
            background: #333;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
        }

        /* Inventory List */
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #444;
        }

        .inventory-list {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .inv-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .inv-item:last-child {
            border-bottom: none;
        }

        .inv-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .inv-img {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
            background: #eee;
        }

        .inv-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .inv-stock-container {
            display: flex;
            gap: 10px;
        }

        .size-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.8rem;
            text-align: center;
            min-width: 40px;
        }

        .size-box span {
            font-weight: bold;
            color: #333;
            display: block;
        }

        .size-box label {
            font-size: 0.7rem;
            color: #999;
        }

        /* Order List Styles */
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .orders-table th,
        .orders-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .orders-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .status-shipped {
            background: #cce5ff;
            color: #004085;
        }

        /* Tabs */
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab-btn {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            color: #000;
            border-bottom: 2px solid #000;
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }
    </style>
</head>

<body>

    <div class="admin-header">
        <h2>Panel DueÃ±a</h2>
        <div>
            <a href="/" class="back-link" style="margin-right: 15px;">Ir a Tienda</a>
            <button onclick="logout()"
                style="background:none; border:none; color:#d9534f; cursor:pointer; font-weight:bold;">
                <i class="fa-solid fa-right-from-bracket"></i> Salir
            </button>
        </div>
    </div>

    <script>
        function logout() {
            sessionStorage.removeItem('admin_logged_in');
            document.cookie = "admin_auth=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            window.location.href = '/login';
        }
    </script>

    <!-- KPI Cards -->
    <!-- Tabs -->
    <!-- Tabs -->
    <div class="admin-tabs">
        <button class="tab-btn active" onclick="switchTab('inventory')">ðŸ“¦ Inventario</button>
        <button class="tab-btn" onclick="switchTab('orders')">ðŸ›’ Pedidos (Nuevos)</button>
        <button class="tab-btn" onclick="switchTab('cms')">ðŸŽ¨ Editor Web</button>
    </div>

    <!-- VIEW: INVENTORY -->
    <div id="view-inventory" class="view-section active">
        <!-- Add Product -->
        <div class="add-product-form">
            <div class="form-title">Agregar Nuevo Producto</div>

            <form id="product-form">
                <div class="form-grid">
                    <input type="text" name="title" placeholder="Nombre de la prenda" required>
                    <select name="category" required>
                        <option value="" disabled selected>CategorÃ­a</option>
                        <option value="vestidos">Vestidos</option>
                        <option value="tops">Blusas & Tops</option>
                        <option value="bottoms">Pantalones</option>
                        <option value="calzado">Calzado</option>
                    </select>
                    <input type="number" name="price" placeholder="Precio ($)" step="0.01" required>
                    <input type="text" name="description" placeholder="DescripciÃ³n breve" required>
                </div>

                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <input type="number" id="qty-s" placeholder="Cant. S" min="0">
                    <input type="number" id="qty-m" placeholder="Cant. M" min="0">
                    <input type="number" id="qty-l" placeholder="Cant. L" min="0">
                </div>

                <div class="upload-btn-wrapper" id="drop-zone" style="margin-bottom: 20px;">
                    <button class="btn-file" type="button">ðŸ“¸ Subir Foto (Click o Arrastrar aquÃ­)</button>
                    <input type="file" name="image" id="file-input" accept="image/*" required>
                </div>

                <button type="submit" class="submit-btn" id="save-btn">Guardar en Inventario</button>
            </form>
        </div>

        <!-- Inventory List -->
        <div class="section-title">Control de Inventario</div>
        <div class="inventory-list" id="inv-list">
            <!-- Injected by JS -->
            <div style="padding: 20px; text-align: center; color: #888;">Cargando inventario...</div>
        </div>

    </div>
    <!-- END VIEW INVENTORY -->

    <!-- VIEW: ORDERS -->
    <div id="view-orders" class="view-section">
        <div class="section-title">BuzÃ³n de Pedidos</div>
        <div class="inventory-list" style="overflow-x: auto;">
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th>Total</th>
                        <th>Pago</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="orders-list-body">
                    <!-- JS Injected -->
                </tbody>
            </table>
            <div id="no-orders-msg" style="padding:20px; text-align:center; color:#888; display:none;">No hay pedidos
                aÃºn.</div>
        </div>
    </div>

    <!-- VIEW: CMS EDITOR -->
    <div id="view-cms" class="view-section">
        <div class="section-title">PersonalizaciÃ³n del Sitio</div>
        <form id="cms-form" class="add-product-form">
            <div class="form-title">Banner Principal (Hero)</div>
            <div class="form-grid">
                <input type="text" name="heroTitle" id="cms-title" placeholder="TÃ­tulo Principal">
                <input type="text" name="heroSubtitle" id="cms-sub" placeholder="SubtÃ­tulo">
                <input type="text" name="heroImg" id="cms-img" placeholder="URL Imagen de Fondo"
                    style="grid-column: 1/-1;">
            </div>

            <div class="form-title" style="margin-top:20px;">Barra de InformaciÃ³n</div>
            <input type="text" name="infoBar" id="cms-infobar" placeholder="Texto cintillo superior">

            <div class="form-title" style="margin-top:20px;">Redes Sociales & Contacto</div>
            <div class="form-grid">
                <input type="text" name="whatsapp" id="cms-wa" placeholder="Link WhatsApp (https://wa.me/...)">
                <input type="text" name="instagram" id="cms-insta" placeholder="Link Instagram">
                <input type="text" name="tiktok" id="cms-tiktok" placeholder="Link TikTok">
            </div>

            <button type="submit" class="submit-btn" style="margin-top:20px; background:var(--accent);">ðŸ’¾ Guardar
                Cambios</button>
        </form>
    </div>

    <script>
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));

            if (tab === 'inventory') {
                document.querySelector('[onclick="switchTab(\'inventory\')"]').classList.add('active');
                document.getElementById('view-inventory').classList.add('active');
            } else if (tab === 'orders') {
                document.querySelector('[onclick="switchTab(\'orders\')"]').classList.add('active');
                document.getElementById('view-orders').classList.add('active');
                fetchOrders();
            } else if (tab === 'cms') {
                document.querySelector('[onclick="switchTab(\'cms\')"]').classList.add('active');
                document.getElementById('view-cms').classList.add('active');
                fetchCMS();
            }
        }

        async function fetchCMS() {
            try {
                const res = await fetch('/api/content');
                const data = await res.json();

                document.getElementById('cms-title').value = data.heroTitle || '';
                document.getElementById('cms-sub').value = data.heroSubtitle || '';
                document.getElementById('cms-img').value = data.heroImg || '';
                document.getElementById('cms-infobar').value = data.infoBar || '';
                document.getElementById('cms-wa').value = data.whatsapp || '';
                document.getElementById('cms-insta').value = data.instagram || '';
                document.getElementById('cms-tiktok').value = data.tiktok || '';
            } catch (err) { console.error(err); }
        }

        document.getElementById('cms-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                const res = await fetch('/api/content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) alert('Â¡Cambios guardados! Recarga la tienda para verlos.');
                else alert('Error al guardar');
            } catch (err) {
                console.error(err);
                alert('Error de conexiÃ³n');
            }
        });

        async function fetchOrders() {
            try {
                const res = await fetch('/api/orders');
                const orders = await res.json();
                renderOrders(orders);
            } catch (err) { console.error(err); }
        }

        function renderOrders(orders) {
            const tbody = document.getElementById('orders-list-body');
            const noMsg = document.getElementById('no-orders-msg');

            if (orders.length === 0) {
                tbody.innerHTML = '';
                noMsg.style.display = 'block';
                return;
            }

            noMsg.style.display = 'none';
            tbody.innerHTML = orders.map(o => `
                <tr>
                    <td>${new Date(o.date).toLocaleDateString()} ${new Date(o.date).toLocaleTimeString()}</td>
                    <td>
                        <strong>${o.customer}</strong><br>
                        <span style="font-size:0.8rem; color:#666;">Ref: ${o.paymentRef}</span>
                    </td>
                    <td>$${parseFloat(o.total).toFixed(2)}</td>
                    <td>${o.paymentMethod.toUpperCase()}</td>
                    <td><span class="status-badge status-${o.status}">${o.status}</span></td>
                </tr>
            `).join('');
        }

        async function fetchProducts() {
            try {
                const res = await fetch('/api/products');
                const products = await res.json();
                renderInventory(products);
            } catch (err) {
                console.error("Error fetching", err);
            }
        }

        function renderInventory(products) {
            const list = document.getElementById('inv-list');

            // Sort by newest (id is timestamp)
            const sorted = products.sort((a, b) => b.id - a.id);

            list.innerHTML = sorted.map(p => `
                <div class="inv-item">
                    <div class="inv-info">
                        <img src="${p.img}" class="inv-img">
                        <div class="inv-name">${p.title}</div>
                    </div>
                    <div class="inv-stock-container">
                        ${Object.entries(p.sizes).map(([size, details]) => `
                            <div class="size-box">
                                <label>${size}</label>
                                <span>${details.stock}</span>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn-delete" onclick="deleteProduct('${p.id}')" title="Eliminar Producto">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        // Handle Form Submit
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = document.getElementById('save-btn');
            btn.textContent = "Guardando...";
            btn.disabled = true;

            const formData = new FormData(e.target);

            // Construct Sizes JSON
            const sizes = {
                "S": { stock: parseInt(document.getElementById('qty-s').value) || 0 },
                "M": { stock: parseInt(document.getElementById('qty-m').value) || 0 },
                "L": { stock: parseInt(document.getElementById('qty-l').value) || 0 }
            };
            formData.append('sizes', JSON.stringify(sizes));

            try {
                const res = await fetch('/api/products', {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    alert("Â¡Producto Agregado!");
                    e.target.reset();
                    fetchProducts(); // Refresh list
                } else {
                    alert("Error al guardar");
                }
            } catch (err) {
                console.error(err);
                alert("Error de conexiÃ³n");
            } finally {
                btn.textContent = "Guardar en Inventario";
                btn.disabled = false;
            }
        });

        async function deleteProduct(id) {
            if (!confirm('Â¿EstÃ¡s SEGURA de que quieres eliminar este producto? No se puede deshacer.')) return;

            try {
                const res = await fetch(`/api/products/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    // alert('Producto eliminado');
                    fetchProducts(); // Refresh
                } else {
                    alert('Error al eliminar');
                }
            } catch (err) {
                console.error(err);
                alert('Error de conexiÃ³n');
            }
        }


        // Drag and Drop Logic
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const btnFile = dropZone.querySelector('.btn-file');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.classList.add('drag-active');
        }

        function unhighlight(e) {
            dropZone.classList.remove('drag-active');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0) {
                fileInput.files = files;
                updateButtonText(files[0].name);
            }
        }

        fileInput.addEventListener('change', function () {
            if (this.files.length > 0) {
                updateButtonText(this.files[0].name);
            }
        });

        function updateButtonText(name) {
            btnFile.textContent = `âœ… Foto lista: ${name}`;
        }

        document.addEventListener('DOMContentLoaded', fetchProducts);
    </script>
</body>

</html>